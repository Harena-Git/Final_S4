<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Intérêts mensuels - EF</title>
    <link rel="stylesheet" href="theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="fonds.html">Gestion des fonds</a></li>
                <li><a href="loan_types.html">Gestion des types de prêt</a></li>
                <li><a href="client_loans.html">Gestion des prêts clients</a></li>
                <li><a href="monthly_interests.html">Intérêts mensuels</a></li>
                <li><a href="amortissement.html">Simulation d'amortissement</a></li>
                <li><a href="simulation_pret.html">Simulation de prêts</a></li>
              </ul>
        </nav>
    </header>

    <h1>Intérêts mensuels gagnés</h1>

    <div class="filters">
        <label for="start-month">Période de début:</label>
        <input type="month" id="start-month" name="start-month">

        <label for="end-month">Période de fin:</label>
        <input type="month" id="end-month" name="end-month">

        <button id="apply-filters">Appliquer</button>
    </div>

    <div class="results">
        <h2>Tableau des intérêts</h2>
        <div id="interest-table"></div>

        <h2>Graphique des intérêts</h2>
        <canvas id="interest-chart" width="800" height="400"></canvas>
    </div>

    <script>
        let interestChart;

        function loadInterests(start = null, end = null) {
            let url = '/ws/monthly_interests';
            if (start || end) {
                url += `?start=${start || ''}&end=${end || ''}`;
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    // Vérification de la structure des données
                    if (!data || !data.table_data) {
                        throw new Error('Format de données invalide');
                    }

                    renderTable(data.table_data);
                    renderChart(data.chart_data);
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    document.getElementById('interest-table').innerHTML =
                        '<p class="error">Erreur lors du chargement des données</p>';
                });
        }

        function renderTable(data) {
            const tableDiv = document.getElementById('interest-table');

            if (!data || !Array.isArray(data)) {
                tableDiv.innerHTML = '<p class="error">Données invalides</p>';
                return;
            }

            if (data.length === 0) {
                tableDiv.innerHTML = '<p>Aucune donnée disponible pour cette période</p>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th>Mois/Année</th>';
            html += '<th>Intérêts mensuels (€)</th>';
            html += '<th>Nombre de prêts</th>';
            html += '<th>Montant total (€)</th>';
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += `<tr>
            <td>${row.period}</td>
            <td>${parseFloat(row.monthly_interest).toFixed(2)}</td>
            <td>${row.loan_count}</td>
            <td>${parseFloat(row.total_amount).toFixed(2)}</td>
        </tr>`;
            });

            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }
        // function loadInterests(start = null, end = null) {
        //     let url = '/ws/monthly_interests';
        //     if (start || end) {
        //         url += `?start=${start || ''}&end=${end || ''}`;
        //     }

        //     fetch(url)
        //         .then(response => response.json())
        //         .then(data => {
        //             // Afficher le tableau
        //             renderTable(data.table_data);

        //             // Afficher le graphique
        //             renderChart(data.chart_data);
        //         })
        //         .catch(error => console.error('Error:', error));
        // }

        // function renderTable(data) {
        //     const tableDiv = document.getElementById('interest-table');

        //     if (data.length === 0) {
        //         tableDiv.innerHTML = '<p>Aucune donnée disponible</p>';
        //         return;
        //     }

        //     let html = '<table><thead><tr>';
        //     html += '<th>Mois/Année</th>';
        //     html += '<th>Intérêts mensuels (€)</th>';
        //     html += '<th>Nombre de prêts</th>';
        //     html += '<th>Montant total (€)</th>';
        //     html += '</tr></thead><tbody>';

        //     data.forEach(row => {
        //         html += `<tr>
        //             <td>${row.year_month}</td>
        //             <td>${parseFloat(row.monthly_interest).toFixed(2)}</td>
        //             <td>${row.loan_count}</td>
        //             <td>${parseFloat(row.total_amount).toFixed(2)}</td>
        //         </tr>`;
        //     });

        //     html += '</tbody></table>';
        //     tableDiv.innerHTML = html;
        // }

        function renderChart(chartData) {
            const ctx = document.getElementById('interest-chart').getContext('2d');

            if (interestChart) {
                interestChart.destroy();
            }

            interestChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Montant (€)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mois/Année'
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('apply-filters').addEventListener('click', function () {
            const start = document.getElementById('start-month').value;
            const end = document.getElementById('end-month').value;
            loadInterests(start, end);
        });

        // Charger les données au démarrage
        window.onload = function () {
            loadInterests();
        };
    </script>
</body>

<footer>
  <p>Etablissement financier et prêt bancaire - Gestion des fonds</p>
</footer>
</html>